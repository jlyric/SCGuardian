<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>SCGuardian by jlyric</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">SCGuardian</h1>
      <h2 class="project-tagline">Set of functions to perform various tasks in the capacity of examining the online relationship between the ScreenConnect host and client</h2>
      <a href="https://github.com/jlyric/SCGuardian" class="btn">View on GitHub</a>
      <a href="https://github.com/jlyric/SCGuardian/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/jlyric/SCGuardian/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="screenconnect-guardian" class="anchor" href="#screenconnect-guardian" aria-hidden="true"><span class="octicon octicon-link"></span></a>ScreenConnect Guardian</h1>

<pre><code>dev           jlyric@outlook.com - https://github.com/jlyric
build-ver     v0.0.1
build-date    September 16th, 2015
build-sha     91bbab1b8343cd52b6f7b34f6181ad2f7b0efb3e
license       GNU General Public License v3.0
</code></pre>

<h2>
<a id="getting-started" class="anchor" href="#getting-started" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting Started</h2>

<p>The ScreenConnect Guardian is a set of functions to perform various tasks in the capacity of examining the online relationship between the ScreenConnect host and client.  ScreenConnect Guardian is akin to the LogMeIn Guardian in that the script performs various checks and tasks with the shared goal of keeping the ScreenConnect Client online and connected with the ScreenConnect Server.</p>

<h2>
<a id="guardian-powershell-script--screenconnect-extension" class="anchor" href="#guardian-powershell-script--screenconnect-extension" aria-hidden="true"><span class="octicon octicon-link"></span></a>Guardian PowerShell Script &amp; ScreenConnect Extension</h2>

<p>The ScreenConnect Guardian is comprised of two different parts.  The first, a PowerShell script, is built specifically to run on the client machines.  The second, a ScreenConnect extension, contains a small helper function which is called by the PowerShell script.</p>

<p>The core PowerShell function, Start-Guardian, will check reachability of the configured ScreenConnect host by first running an ICMP (ping) test followed by a direct TCP connection to the host on the configured relay port. As the server is up and running the client should be connected, correct?  Not always.  The name of the game with remote access is making sure you have remote access.  The script will make a request to the ScreenConnect Guardian Extension for online status of the client at the server console to determine the current online relationship and act accordingly.  If the server is showing the client as offline, but reachability is good from the client to host -- restart the client service to reestablish the connection relationship.</p>

<h2>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Requirements</h2>

<h5>
<a id="extension" class="anchor" href="#extension" aria-hidden="true"><span class="octicon octicon-link"></span></a>Extension</h5>

<ul>
<li>Windows only?</li>
</ul>

<p>The extension has been tested on ScreenConnect Servers running Microsoft variants.  I'm not sure what the extension architecture looks like on other operating systems.  When time is available I will spin up a Linux VM and quickly setup a vanilla ScreenConnect installation to take a look and report back.</p>

<h5>
<a id="powershell-script" class="anchor" href="#powershell-script" aria-hidden="true"><span class="octicon octicon-link"></span></a>PowerShell Script</h5>

<ul>
<li>Windows only.</li>
<li>PowerShell v2.0+ (XP [KB968930], Vista [KB968930], 7, 8, 8.1, 10)</li>
<li>Administrative Client Rights through ScreenConnect</li>
</ul>

<p>Most of the forum reports and my own testing are having trouble keeping ScreenConnect clients connected with machines running Windows Vista and above.  The PowerShell script will run on machines with PowerShell 2.0 and greater.  Functions and Cmdlets were chosen to target the lowest possible version of PowerShell to open the door to a greater number of clients.</p>

<h2>
<a id="installing-the-screenconnect-guardian-extension" class="anchor" href="#installing-the-screenconnect-guardian-extension" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the ScreenConnect Guardian Extension</h2>

<ul>
<li>Download the latest version the ScreenConnect Guardian Package</li>
<li>
<p>Unzip and copy the contents of the Extension folder to your App_Extensions directory on your ScreenConnect Server.  Your directory structure should look something like the following:</p>

<p><code>C:\Program Files (x86)\ScreenConnect\App_Extensions\de9b663e-1025-46dc-b16f-e9e00785f4d1\</code></p>
</li>
<li>The default extension GUID is <code>de9b663e-1025-46dc-b16f-e9e00785f4d1</code>, should you change this GUID you will need to make adjustments in the PowerShell script outlined a bit later in the document.</li>
<li>The ScreenConnect Guardian should now be showing in the Admin area of your ScreenConnect Server.</li>
<li>Click the <b>Options</b> menu and select <b>Edit Settings</b>.</li>
<li>In the settings window, change the IntegrationKey to something different if you desire.  Remember the IntegrationKey as you will need to update the PowerShell script should you change it.</li>
<li>Done!</li>
</ul>

<h6>
<a id="in-the-end-im-not-sure-this-extension-may-even-be-necessary--perhaps-someone-speaks-up-with-a-simple-native-api-call-to-achieve-our-goal-of-getting-the-client-online-status-at-the-server-level" class="anchor" href="#in-the-end-im-not-sure-this-extension-may-even-be-necessary--perhaps-someone-speaks-up-with-a-simple-native-api-call-to-achieve-our-goal-of-getting-the-client-online-status-at-the-server-level" aria-hidden="true"><span class="octicon octicon-link"></span></a>In the end, I'm not sure this Extension may even be necessary.  Perhaps someone speaks up with a simple <code>native</code> API call to achieve our goal of getting the client online-status at the server-level.</h6>

<h2>
<a id="installing-the-screenconnect-powershell-script" class="anchor" href="#installing-the-screenconnect-powershell-script" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing the ScreenConnect PowerShell Script</h2>

<ul>
<li>Download the latest version of the ScreenConnect Guardian Package</li>
<li>Unzip and within the PowerShell folder you will find <code>SCGuardian.ps1</code> which is the client script.</li>
<li>Make adjustments to the necessary configuration options outlined in the table below.</li>
<li>Place in your ScreenConnect Toolbox for easy access and transfer.</li>
<li>Transfer SCGuardian.ps1 to your client and move the script if you do not like where ScreenConnect drops it on the client machine.  <code>-install</code> flag anyone?</li>
<li>
<p>Execute the following commands in the Command section of your ScreenConnect console.</p>

<p><code>powershell -executionpolicy bypass -file "c:\users\demo\files\SCGuardian.ps1" -register -recovery -delayedstart</code></p>
</li>
</ul>

<h5>
<a id="command-above-will-perform-the-following---" class="anchor" href="#command-above-will-perform-the-following---" aria-hidden="true"><span class="octicon octicon-link"></span></a>Command above will perform the following --</h5>

<ul>
<li>Register a task to run the script every 5 minutes with the <code>-check</code> flag.</li>
<li>Set client service auto-recovery settings to Restart/Restart/Take No Action.</li>
<li>Set the ScreenConnect Client service to Automatic (Delayed Start)</li>
</ul>

<h2>
<a id="scguardianps1---configuration-settings" class="anchor" href="#scguardianps1---configuration-settings" aria-hidden="true"><span class="octicon octicon-link"></span></a>SCGuardian.ps1 - Configuration Settings</h2>

<p>The script will handle finding the necessary information needed to peform its job based on various factors.  However, the settings below revolve around changes outside of the client so adjustments to the script based on your needs may be necessary.  For example, does your ScreenConnect Server run SSL?  Non-standard HTTP and/or Relay Port?</p>

<h6>
<a id="strserversettings" class="anchor" href="#strserversettings" aria-hidden="true"><span class="octicon octicon-link"></span></a>$strServerSettings</h6>

<table>
<tr>
  <td>SSL</td>
  <td>Set to <b>True</b> if your ScreenConnect Server is running SSL</td>
</tr>
<tr>
  <td>Port</td>
  <td>Set to <b>443</b> if running SSL, otherwise set to Port running the SC web service.</td>
</tr>
<tr>
  <td>ExtDir</td>
  <td>Leave set <b>App_Extensions</b> unless you have a customized installation.</td>
</tr>
<tr>
  <td>ExtGUID</td>
  <td>If the <b>Extension GUID</b> of the Guardian Extension is different on your server, change this value.</td>
</tr>
<tr>
  <td>EndPoint</td>
  <td>
<b>Service.ashx</b> - ScreenConnect Guardian Extension Endpoint</td>
</tr>
<tr>
  <td>Secret</td>
  <td>
<b>IntegrationKey</b> - The IntegrationKey which was set in the Extension settings.</td>
</tr>
<tr>
  <td>Method</td>
  <td>
<b>ConsoleConnectionStatus</b> - Method the script will call to check a client GUID.</td>
</tr>
</table>

<h6>
<a id="strclientsettings" class="anchor" href="#strclientsettings" aria-hidden="true"><span class="octicon octicon-link"></span></a>$strClientSettings</h6>

<table>
<tr>
  <td>RelayPort</td>
  <td>
<b>8041</b> - If configured differently at your server, update this value.</td>
</tr>
<tr>
  <td>LogDir</td>
  <td>Set your Logging Directory.  By default, logs are saved to the script directory.</td>
</tr>
<tr>
  <td>LogFileName</td>
  <td>Set the name of the log file.</td>
</tr>
</table>

<h2>
<a id="scguardianps1---switch-flags" class="anchor" href="#scguardianps1---switch-flags" aria-hidden="true"><span class="octicon octicon-link"></span></a>SCGuardian.ps1 - Switch Flags</h2>

<h5>
<a id="-check" class="anchor" href="#-check" aria-hidden="true"><span class="octicon octicon-link"></span></a>-check</h5>

<p><code>./SCGuardian.ps1 -check</code></p>

<p>When executed, the Start-Guardian function will test the reachability of the ScreenConnect host followed by checking with the Guardian Extension at the server-level to verify the server sees the client as connected. The reachability test is an ICMP (ping) test for troubleshooting followed by a direct TCP connection to the configured Relay Port.  If the server is reachable, the Guardian Extension is called with the client GUID to check the status at the console.  If the server reports back that the client appears "offline" the script will restart the ScreenConnect Client in an attempt to reestablish connection.</p>

<h5>
<a id="-delayedstart" class="anchor" href="#-delayedstart" aria-hidden="true"><span class="octicon octicon-link"></span></a>-delayedstart</h5>

<p><code>./SCGuardian.ps1 -delayedstart</code></p>

<p>Slow or problematic machines, specifically during startup, can create timeout scenarios with the client service.  Having said that, running this flag will set the ScreenConnect Client Service to Automatic (Delayed Start) to try and ease the issue.</p>

<h5>
<a id="-register" class="anchor" href="#-register" aria-hidden="true"><span class="octicon octicon-link"></span></a>-register</h5>

<p><code>./SCGuardian.ps1 -register</code></p>

<p>This flag will register a scheduled task at 5 minute intervals to run the <code>-check</code> flag.  A separate function has been provided for "old school" scheduled tasks via SCHTASKS to support PowerShell 2.0 as well as the newer PowerShell 3.0+ functions to create tasks.</p>

<h5>
<a id="-recovery" class="anchor" href="#-recovery" aria-hidden="true"><span class="octicon octicon-link"></span></a>-recovery</h5>

<p><code>./SCGuardian.ps1 -recovery</code></p>

<p>Running this flag will set the ScreenConnect Client service Automatic Recovery Options.  The options will be set to First Failure - Restart, Second Failure - Restart, Subsequent Failures - Take No Action.</p>

<h5>
<a id="-stop" class="anchor" href="#-stop" aria-hidden="true"><span class="octicon octicon-link"></span></a>-stop</h5>

<p><code>./SCGuardian.ps1 -stop</code></p>

<p>Stop the ScreenConnect Client Service.</p>

<h5>
<a id="-start" class="anchor" href="#-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>-start</h5>

<p><code>./SCGuardian.ps1 -start</code></p>

<p>Start the ScreenConnect Client Service.</p>

<h5>
<a id="-restart" class="anchor" href="#-restart" aria-hidden="true"><span class="octicon octicon-link"></span></a>-restart</h5>

<p><code>./SCGuardian.ps1 -restart</code></p>

<p>Restart the ScreenConnect Client Service.</p>

<h2>
<a id="contribute" class="anchor" href="#contribute" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contribute</h2>

<ul>
<li>Fork it!</li>
<li>Create your feature branch: <code>git checkout -b my-new-feature</code>
</li>
<li>Commit your changes: <code>git commit -am 'my new feature'</code>
</li>
<li>Push to the branch: <code>git push origin my-new-feature</code>
</li>
<li>Submit a pull request <code>:D</code>
</li>
</ul>

<h2>
<a id="history" class="anchor" href="#history" aria-hidden="true"><span class="octicon octicon-link"></span></a>History</h2>

<p>Release and Revision History
1. <code>v0.0.1   Alpha as Fuck</code></p>

<h2>
<a id="credits" class="anchor" href="#credits" aria-hidden="true"><span class="octicon octicon-link"></span></a>Credits</h2>

<ul>
<li>My Muse AZ</li>
<li>LogMeIn Business Practices</li>
<li>Reno 911!</li>
<li>Guys &amp; Gals in the ScreenConnect Forums</li>
</ul>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>GNU General Public License v3.0</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/jlyric/SCGuardian">SCGuardian</a> is maintained by <a href="https://github.com/jlyric">jlyric</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-67751401-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
